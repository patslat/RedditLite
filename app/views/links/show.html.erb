<%= render @link %>

<form action="<%= link_comments_url(@link) %>" method="post">
  <input type="hidden" name="authenticity_token"
    value="form_authenticity_token">
  <input type="hidden" name="comment[author_id]"
    value="<%= current_user.id %>">
  <input type="hidden" name="comment[link_id]" value="<%= @link.id %>">

  <label for="comment">Comment on this Link:</label>
  <input type="text" name="comment[body]" id="comment">

  <input type="submit" value="Submit Comment">
</form>
<% unless @comment_tree.empty? %>
  <% nesting_ids = [@comment_tree.first.id] %>
  <% current_id = @comment_tree.first.id %>
  <% @comment_tree.each do |comment| %>

    <% if comment.parent_comment.nil? %>
    <%= render comment %>
    <% next %>
    <% end %>

    <% if nesting_ids.include?(comment.parent_comment.id) &&
          current_id == comment.parent_comment.id%>

    <li><%= render comment %></li>

    <% elsif nesting_ids.include?(comment.parent_comment.id) &&
             current_id != comment.parent_comment.id %>
    </ul>
    <% current_id = comment.parent_comment.id %>
    <li><%= render comment %></li>

    <% else %>
    <ul>
    <% nesting_ids << comment.parent_comment.id %>
    <% current_id = comment.parent_comment.id %>

    <li><%= render comment%></li>
    <% end %>

  <% end %>
<% end %>